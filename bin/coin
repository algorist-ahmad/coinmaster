#!/bin/bash

if [[ "$1" == 'debug' ]]; then shift ; set -x ; fi

VERSION='0.2.0'

# Entry point to my program. Loads config.yml then routes to the appropriate subprogram as instrcuted
# from the first argument.

# STATUS: NOTHING PLANNED
# TESTS:  PASSED but undocumented

ROOT=$( dirname "$(dirname "$(readlink -f "$0")")" )

set -o pipefail
# set -u # example: /home/ahmad/bin/auto: line 23: ROOT: unbound variable, holy shit this is amazing
# set -e # sideffects maybe

export ROOT # don't fail me, the config loader relies on you!

source "$ROOT/src/config-loader.sh"
source "$ROOT/src/dependency/manager.sh"

CONFIGFILE="$ROOT/config.yml"
HELPFILE="$ROOT/help.txt"
ARGS="$@"

# Define options as an array to preserve spaces
COIN_OBJECTS=(
  "transaction:txn"
  "bill:bill"
  "payment distribution plan:plan"  # No escaping needed in array
  "contract:contract"
)

CMD_ACCOUNT="$ROOT/src/account/manager.sh"
CMD_TRANSAC="$ROOT/src/transaction/manager.sh"
CMD_PLAN="$ROOT/src/pdplan/manager.sh"

CMD_BILL="$ROOT/src/task.sh" # FLAGGED FOR REMOVAL
CMD_LIST="$ROOT/src/list.sh" # FLAGGED FOR REMOVAL
CMD_TASK="$ROOT/src/task.sh" # FLAGGED FOR REMOVAL
CMD_INSERT="$ROOT/src/insert.sh" # FLAGGED FOR REMOVAL
CMD_BALANCE="$ROOT/src/balance.sh" # FLAGGED FOR REMOVAL

DEFAULT_FN='undefined_function'  # Defined in config

main() {
  check_dependencies_warn
  load_config_file
  dispatch $ARGS   # notice: no quotes, something changed here!
  print_last_updated
}

# FIXME
print_last_updated() {
  local timestamp=$(yq .last_updated "$HOME/collections/coin/meta.yml")
  local current_time=$(date +%s)
  local updated_time=$(date -d "$timestamp" +%s)
  local diff=$((current_time - updated_time))
  
  # ANSI style codes
  local bold="\033[1m"
  local cyan="\033[38;5;51m"
  local magenta="\033[38;5;201m"
  local yellow="\033[38;5;226m"
  local reset="\033[0m"

  # Calculate relative time
  local relative_time
  if (( diff < 60 )); then
    relative_time="${diff} seconds ago"
  elif (( diff < 3600 )); then
    relative_time="$((diff / 60)) minutes ago"
  elif (( diff < 86400 )); then
    relative_time="$((diff / 3600)) hours ago"
  else
    relative_time="$((diff / 86400)) days ago"
  fi

  # Format output with styles
  echo -e "\n${bold}${cyan}Last updated:${reset}" \
    "${magenta}$(date -d "$timestamp" '+%Y-%m-%d %H:%M:%S')" \
    "${yellow}(${relative_time})${reset}"
}

# load config from config.yml
load_config_file() {
  DEFAULT_FN=$(config_get 'default_command')
}

dispatch() {
  case "$1" in
    # standard
    help | --help | -h)     shift ; show_help    ;;
    ver* | --version | -v)  shift ; show_version ;;

    # special
      new) shift ; create_new_object "$@" ;;
    --dev) shift ; echo "DEV MODE: shortcut to gh and git to aid in development" ;;
    export) shift ; do_transac export ;;
    vd)     launch_visidata ;;

    # managers
    acc* | --account* | -A | bal*) shift ; do_account "$@" ;;
    txn  | --txn | trans* | -t)    shift ; do_transac "$@" ;; # replaces `bill`
    plan | --plan | -P )           shift ; do_plan    "$@" ;; # undocced

    # shortcuts
    add   | --add  | -a)  shift ; do_transac add  "$@"   ;; # untested
    bill* | --bill | -b)  shift ; do_transac bill "$@"   ;; # untested
    log   | --log  | -aa) shift ; do_transac log  "$@"   ;; # not implemented

    # unimplemented
    --generate-*mail)       shift ; do_generate_email "$@"    ;; # undocumented TODO
    --generate-task?)       shift ; do_generate_task "$@"     ;; # undocumented TODO
    --generate-cal*)        shift ; do_generate_calendar "$@" ;; # undocumented TODO
    
    # catch-all
    '') do_summary         ;;
    * ) do_transac "$ARGS" ;;
    
  esac
}

launch_visidata() {
  if ! command -v vd >/dev/null; then
    >&2 echo "You need to have Visidata installed to use this command."
    if ! command -v gum; then sudo pacman -S gum; fi
    if gum confirm "Install vd?"; then sudo pacman -S vd; fi
  fi
  [[ -z "$COINDATA" ]] && >&2 echo "variable \$COINDATA not defined" && exit 11
  [[ ! -d "$COINDATA" ]] && >&2 echo "dir $COINDATA does not exists" && exit 12
  vd "$COINDATA"
}

config_get() { echo $(yq ".$*" "$CONFIGFILE") ; }

do_account() { "$CMD_ACCOUNT" "$@" ; }
do_transac() { "$CMD_TRANSAC" "$@" ; }
do_plan()    { "$CMD_PLAN"    "$@" ; }

do_bill()    { "$CMD_BILL"    "$@" ; } # DEPRECATED
do_list()    { "$CMD_LIST"    "$@" ; } # DEPRECATED
do_task()    { "$CMD_TASK"    "$@" ; } # DEPRECATED
do_insert()  { "$CMD_INSERT"  "$@" ; } # DEPRECATED
do_balance() { "$CMD_BALANCE" "$@" ; } # DEPRECATED

# The original purpose of Coinmaster was simply to track bills deadlines and view account balances.
# This summary adheres to this original purpose.
do_summary() {
  # echo -e "Upcoming bills:"
  do_transac                 # view upcoming bills
  do_account balance --total # view total balance
  echo -e "\nDo \`coin acc\` to check balance"
}

show_help() { echo -e "$(cat $HELPFILE)" | less ; }
show_version() { echo -e "coin $VERSION" ; }

# handle_unknown_args() {
#   >&2 echo "PASSING TO COMMAND: list.sh"
#   do_list $ARGS
# }

# txn, bill, plan, contract
create_new_object() {

  if command -v gum
    then object_to_create=$(gum choose --header="New what?" --cursor="> new " --label-delimiter=":" "${COIN_OBJECTS[@]}")
    else cmd_not_found_exception
  fi

  case "$object_to_create" in
    txn) do_transac add  "$@" ;;
    # bill) do_transac add  "$@"  ;;
    plan) echo "Not implemented, create an issue with \`gh issue create\`"  ;;
    contract) echo "Not implemented, create an issue with \`gh issue create\`"  ;;
  esac 
}

cmd_not_found_exception() {
  >&2 echo -e "Command \`gum\` required, do: sudo pacman -S gum"
}

main
